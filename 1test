document.addEventListener('DOMContentLoaded', () => {
    const API_BASE_URL = 'http://127.0.0.1:5000/api';
    // â˜…ç®¡ç†è€…APIã‚’ä¿è­·ã—ãŸå ´åˆã€ã“ã“ã«APIã‚­ãƒ¼ã‚’å®šç¾©ã—ã¦ãã ã•ã„
    // const ADMIN_API_KEY = "your-very-secret-and-long-api-key";

    // --- UIè¦ç´ ã®å–å¾— ---
    const productsTableBody = document.querySelector('#products-table tbody');
    const uploadBtn = document.getElementById('upload-btn');
    const menuFileInput = document.getElementById('menu-file-input');
    const addProductForm = document.getElementById('add-product-form');
    const downloadBtn = document.getElementById('download-btn');
    
    // --- ä¿®æ­£ãƒ¢ãƒ¼ãƒ€ãƒ«é–¢é€£ã®UIè¦ç´  ---
    const editModalOverlay = document.getElementById('edit-modal-overlay');
    const editForm = document.getElementById('edit-product-form');
    const cancelEditBtn = document.getElementById('cancel-edit-btn');
    const editIdInput = document.getElementById('edit-id');

    // --- ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° ---
    let allProducts = [];

    // --- å¿…é ˆè¦ç´ ã®å­˜åœ¨ãƒã‚§ãƒƒã‚¯ ---
    if (!productsTableBody || !uploadBtn || !menuFileInput || !addProductForm || !downloadBtn || !editModalOverlay) {
        console.error("ç®¡ç†ç”»é¢ã®å¿…é ˆHTMLè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚IDãŒæ­£ã—ã„ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
        return;
    }

    /**
     * å•†å“ãƒªã‚¹ãƒˆã‚’APIã‹ã‚‰èª­ã¿è¾¼ã¿ã€ãƒ†ãƒ¼ãƒ–ãƒ«ã«æç”»ã™ã‚‹
     */
    async function loadProducts() {
        try {
            const response = await fetch(`${API_BASE_URL}/get_products`);
            if (!response.ok) {
                throw new Error(`API error: ${response.status}`);
            }
            allProducts = await response.json();
            
            productsTableBody.innerHTML = '';
            allProducts.forEach(product => {
                const tr = document.createElement('tr');
                tr.dataset.productId = product.id;
                
                const soldOutBtnText = product.is_sold_out ? 'è²©å£²å†é–‹' : 'å“åˆ‡ã‚Œ';
                const soldOutBtnClass = product.is_sold_out ? 'action-btn in-stock-btn' : 'action-btn sold-out-btn';

                tr.innerHTML = `
                    <td>${product.id}</td>
                    <td>${product.name}</td>
                    <td>${product.price.toLocaleString()}</td>
                    <td>${product.category || ''}</td>
                    <td>
                        <button class="${soldOutBtnClass}" data-id="${product.id}" data-current-state="${product.is_sold_out}">
                            ${soldOutBtnText}
                        </button>
                    </td>
                    <td>
                        <button class="action-btn edit-btn" data-id="${product.id}">ä¿®æ­£</button>
                        <button class="delete-btn" data-id="${product.id}" title="å‰Šé™¤">ğŸ—‘ï¸</button>
                    </td>
                `;
                productsTableBody.appendChild(tr);
            });
        } catch (error) {
            console.error('ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—:', error);
            productsTableBody.innerHTML = '<tr><td colspan="6">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚µãƒ¼ãƒãƒ¼ãŒèµ·å‹•ã—ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚</td></tr>';
        }
    }

    /**
     * ä¿®æ­£ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãã€é¸æŠã•ã‚ŒãŸå•†å“ã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ•ã‚©ãƒ¼ãƒ ã«è¨­å®šã™ã‚‹
     */
    function openEditModal(productId) {
        const productToEdit = allProducts.find(p => p.id === productId);
        if (!productToEdit) {
            console.error("ä¿®æ­£å¯¾è±¡ã®å•†å“ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚");
            return;
        }

        editIdInput.value = productToEdit.id;
        document.getElementById('edit-name').value = productToEdit.name;
        document.getElementById('edit-price').value = productToEdit.price;
        document.getElementById('edit-category').value = productToEdit.category || '';
        document.getElementById('edit-description').value = productToEdit.description || '';
        document.getElementById('edit-image').value = productToEdit.image_path || '';
        
        editModalOverlay.classList.remove('hidden');
    }

    /**
     * ä¿®æ­£ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
     */
    function closeEditModal() {
        editModalOverlay.classList.add('hidden');
        editForm.reset();
    }


    // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š ---

    /**
     * ç¾åœ¨ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹
     */
    downloadBtn.addEventListener('click', async () => {
        if (!confirm('ç¾åœ¨ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’Excelãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã‹ï¼Ÿ')) {
            return;
        }

        try {
            const response = await fetch(`${API_BASE_URL}/admin/download_menu`, {
                method: 'GET',
                // headers: { 'X-Admin-API-Key': ADMIN_API_KEY } // APIã‚­ãƒ¼èªè¨¼ã‚’ä½¿ã†å ´åˆ
            });

            if (response.ok) {
                const blob = await response.blob();
                const disposition = response.headers.get('Content-Disposition');
                let filename = 'menu_backup.xlsx';

                if (disposition && disposition.indexOf('attachment') !== -1) {
                    const filenameRegex = /filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/;
                    const matches = filenameRegex.exec(disposition);
                    if (matches != null && matches[1]) {
                        filename = matches[1].replace(/['"]/g, '');
                    }
                }
                
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                a.remove();
            } else {
                const error = await response.json();
                alert(`ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`);
            }
        } catch (error) {
            console.error('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:', error);
            alert('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
        }
    });

    /**
     * Excelãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹
     */
    uploadBtn.addEventListener('click', async () => {
        const file = menuFileInput.files[0];
        if (!file) {
            alert('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
            return;
        }
        if (!confirm('æœ¬å½“ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã‹ï¼Ÿæ—¢å­˜ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¯å…¨ã¦ä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚')) {
            return;
        }

        const formData = new FormData();
        formData.append('menu_file', file);

        try {
            const response = await fetch(`${API_BASE_URL}/admin/upload_menu`, {
                method: 'POST',
                body: formData,
                // headers: { 'X-Admin-API-Key': ADMIN_API_KEY } // APIã‚­ãƒ¼èªè¨¼ã‚’ä½¿ã†å ´åˆ
            });
            const result = await response.json();
            alert(result.message);
            if (response.ok) {
                loadProducts();
            }
        } catch (error) {
            alert('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
            console.error(error);
        }
    });

    /**
     * æ–°ã—ã„ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¿½åŠ ã™ã‚‹ãƒ•ã‚©ãƒ¼ãƒ ã®é€ä¿¡ã‚¤ãƒ™ãƒ³ãƒˆ
     */
    addProductForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const newProduct = {
            name: document.getElementById('new-name').value,
            price: parseInt(document.getElementById('new-price').value, 10),
            category: document.getElementById('new-category').value,
            description: document.getElementById('new-description').value,
            image_path: document.getElementById('new-image').value
        };
        
        try {
            const response = await fetch(`${API_BASE_URL}/admin/add_product`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    // 'X-Admin-API-Key': ADMIN_API_KEY // APIã‚­ãƒ¼èªè¨¼ã‚’ä½¿ã†å ´åˆ
                },
                body: JSON.stringify(newProduct)
            });
            
            if (response.ok) {
                alert('ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚');
                addProductForm.reset();
                loadProducts();
            } else {
                const result = await response.json();
                alert(`è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ: ${result.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'}`);
            }
        } catch (error) {
            console.error('è¿½åŠ ã‚¨ãƒ©ãƒ¼:', error);
            alert('ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®è¿½åŠ å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
        }
    });

    /**
     * å•†å“ãƒ†ãƒ¼ãƒ–ãƒ«å†…ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆä¿®æ­£ã€å‰Šé™¤ã€å“åˆ‡ã‚Œãƒˆã‚°ãƒ«ï¼‰
     */
    productsTableBody.addEventListener('click', async (e) => {
        const target = e.target;
        const buttonWithId = target.closest('[data-id]');
        if (!buttonWithId) return;

        const productId = parseInt(buttonWithId.dataset.id, 10);

        if (buttonWithId.classList.contains('edit-btn')) {
            openEditModal(productId);
        }
        
        else if (buttonWithId.classList.contains('sold-out-btn') || buttonWithId.classList.contains('in-stock-btn')) {
            const currentState = parseInt(buttonWithId.dataset.currentState, 10);
            const newState = currentState === 0 ? 1 : 0;
            try {
                const response = await fetch(`${API_BASE_URL}/admin/update_product_status/${productId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        // 'X-Admin-API-Key': ADMIN_API_KEY // APIã‚­ãƒ¼èªè¨¼ã‚’ä½¿ã†å ´åˆ
                    },
                    body: JSON.stringify({ is_sold_out: newState })
                });
                if (response.ok) {
                    loadProducts();
                } else {
                    alert('çŠ¶æ…‹ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                }
            } catch (error) {
                console.error('çŠ¶æ…‹æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
                alert('çŠ¶æ…‹ã®æ›´æ–°å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
            }
        }
        
        else if (buttonWithId.classList.contains('delete-btn')) {
            if (confirm(`ID: ${productId} ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
                try {
                    await fetch(`${API_BASE_URL}/admin/delete_product/${productId}`, {
                        method: 'POST',
                        // headers: { 'X-Admin-API-Key': ADMIN_API_KEY } // APIã‚­ãƒ¼èªè¨¼ã‚’ä½¿ã†å ´åˆ
                    });
                    loadProducts();
                } catch (error) {
                    console.error('å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
                    alert('ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®å‰Šé™¤å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
                }
            }
        }
    });

    /**
     * ä¿®æ­£ãƒ•ã‚©ãƒ¼ãƒ ã®ã€Œä¿å­˜ã€ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ
     */
    editForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const productId = editIdInput.value;
        const updatedProduct = {
            name: document.getElementById('edit-name').value,
            price: parseInt(document.getElementById('edit-price').value, 10),
            category: document.getElementById('edit-category').value,
            description: document.getElementById('edit-description').value,
            image_path: document.getElementById('new-image').value,
        };

        try {
            const response = await fetch(`${API_BASE_URL}/admin/update_product/${productId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    // 'X-Admin-API-Key': ADMIN_API_KEY // APIã‚­ãƒ¼èªè¨¼ã‚’ä½¿ã†å ´åˆ
                },
                body: JSON.stringify(updatedProduct)
            });
            const result = await response.json();
            alert(result.message);
            if (response.ok) {
                closeEditModal();
                loadProducts();
            }
        } catch (error) {
            console.error("æ›´æ–°ã‚¨ãƒ©ãƒ¼:", error);
            alert("ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®æ›´æ–°å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚");
        }
    });

    // ä¿®æ­£ãƒ•ã‚©ãƒ¼ãƒ ã®ã€Œã‚­ãƒ£ãƒ³ã‚»ãƒ«ã€ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ
    cancelEditBtn.addEventListener('click', closeEditModal);

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã®å¤–å´ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸæ™‚ã«é–‰ã˜ã‚‹
    editModalOverlay.addEventListener('click', (e) => {
        if (e.target === editModalOverlay) {
            closeEditModal();
        }
    });

    // --- åˆæœŸåŒ–å‡¦ç† ---
    loadProducts();
});